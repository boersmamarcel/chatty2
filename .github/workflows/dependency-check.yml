name: Dependency Update Check

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Dependency Triage
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            # Dependency Update Check for Chatty Release

            TASK: Check for important dependency updates and create GitHub issues for recommended upgrades.

            ## Core Dependencies to Monitor
            - rig-core (LLM operations)
            - rmcp (Model Context Protocol)
            - gpui, gpui-component (UI framework from Zed)
            - tokio (async runtime)
            - serde, serde_json (serialization)
            - reqwest (HTTP client)
            - typst, typst-svg (math rendering)
            - pdfium-render (PDF processing)
            - azure_identity, azure_core (Entra ID auth)

            ## Instructions

            1. Read Cargo.toml to get current versions
            2. For each core dependency, query crates.io API:
               - Endpoint: https://crates.io/api/v1/crates/{crate_name}
               - Extract latest stable version (not pre-release)
            3. Compare versions (use semantic versioning):
               - Major (x.0.0): Breaking changes
               - Minor (0.x.0): New features, backwards compatible
               - Patch (0.0.x): Bug fixes
            4. For significant updates, investigate:
               - Check changelog/release notes
               - Look for security fixes (CRITICAL)
               - Assess breaking changes
               - Evaluate new features vs risk
            5. Decide which updates to recommend:
               - ALWAYS: Security fixes
               - RECOMMEND: Major/minor with significant value
               - SKIP: Patch updates unless critical bugs
               - AVOID: Very recent releases (< 1 week) unless security
            6. Create GitHub issues for recommendations:
               - Title: "Dependency Update: {crate} {current} â†’ {latest}"
               - Include: version change, type (major/minor/patch), reasoning, changelog link
               - Labels: "dependency-update", "priority:{critical|high|medium|low}", "automated"
               - Use: gh issue create --title "..." --body "..." --label "..."

            IMPORTANT: Before creating issues, check for existing open issues about the same dependency
            to avoid duplicates. Use: gh issue list --label "dependency-update" --state open

            ## Decision Criteria
            - Security fixes: Always upgrade (critical priority)
            - Breaking changes: Assess migration cost vs benefits
            - New features: Evaluate usefulness for Chatty's use case
            - Stability: Prefer established releases over bleeding edge
            - Compatibility: Consider impact on other dependencies

            ## Project Context
            Chatty is a desktop chat app using GPUI for UI, rig-core for LLM integration,
            rmcp for MCP support, and typst for math rendering. Prioritize stability
            for UI/rendering dependencies, but stay current with LLM/MCP libraries
            for latest AI capabilities.

            After creating issues, provide a summary of what you found and what actions you took.

          claude_args: '--allowed-tools "Bash(curl:*),Bash(wget:*),Bash(gh issue:*)"'
