name: Dependency Update Check

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:

jobs:
  check-dependencies:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Dependency Triage
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--allowed-tools "Read,WebFetch,WebSearch,Bash(cargo *),Bash(jq *),Bash(gh issue create:*),Bash(gh issue list:*),Bash(gh issue close:*),Bash(gh issue comment:*)"'
          prompt: |
            # Dependency Update Check for Chatty Release

            TASK: Check for important dependency updates and create GitHub issues ONLY for high-value upgrades.

            ## High-Priority Dependencies (check these)
            Only check dependencies that are core to the application's functionality:
            - rig-core (LLM operations — CRITICAL, stay current)
            - rmcp (Model Context Protocol — CRITICAL, stay current)
            - gpui, gpui-component (UI framework — check for important fixes)
            - azure_identity, azure_core (Entra ID auth — check for security fixes)
            - typst, typst-svg (math rendering — check for important fixes)
            - pdfium-render (PDF processing — check for important fixes)

            ## Do NOT create issues for
            - Utility crates: uuid, thiserror, anyhow, serde, serde_json, tokio, reqwest, nix, log, tracing, etc.
            - Patch-only updates (0.0.x) unless they fix a security vulnerability
            - Minor updates to stable/mature crates that don't add features we need
            - Any crate not in the high-priority list above

            ## Instructions

            ### Step 1: Read current versions
            Read Cargo.toml and note versions of the high-priority dependencies only.

            ### Step 2: Check latest versions
            For each high-priority dependency, query the crates.io API:
            - URL: https://crates.io/api/v1/crates/{crate_name}
            - Extract the latest stable version (not pre-release/alpha/beta/rc)

            ### Step 3: Filter — be VERY selective
            Only proceed to issue creation if ALL of these are true:
            - The update is for a high-priority dependency
            - There is a meaningful version difference (not just a patch bump)
            - The update provides concrete value: security fix, bug fix we hit, or feature we need
            - For rig-core and rmcp: any minor+ bump qualifies (we want latest AI capabilities)
            - For everything else: only security fixes or major feature additions qualify

            ### Step 4: Deduplicate against existing issues
            CRITICAL — search by title, not by label (labels may not exist):
            - Run: gh issue list --state open --search "Dependency Update" --limit 100
            - For each crate you want to file, check if ANY open issue already mentions that crate name
            - If an open issue exists for that crate (even at an older version):
              - If the existing issue targets the SAME version: skip entirely
              - If the existing issue targets an OLDER version: close it with a comment
                "Superseded by #NEW" and create the new issue
            - Group related crates into ONE issue (e.g., azure_identity + azure_core together)

            ### Step 5: Create issues (sparingly)
            - Title: "Dependency Update: {crate} {current} → {latest}"
            - For grouped crates: "Dependency Update: {crate1} + {crate2} {current} → {latest}"
            - Body must include: why this update matters, what changed, link to changelog
            - Use: gh issue create --title "..." --body "..."
            - Do NOT add labels (they may not exist in the repo)

            ## Quality Bar
            Ask yourself before creating each issue: "Would a maintainer thank me for this,
            or would they close it as noise?" If the answer is noise, do NOT create the issue.
            Creating 0 issues is a perfectly valid outcome if nothing important changed.

            ## Project Context
            Chatty is a desktop chat app using GPUI for UI, rig-core for LLM integration,
            rmcp for MCP support, and typst for math rendering. Prioritize staying current
            with LLM/MCP libraries (rig-core, rmcp) for latest AI capabilities. For everything
            else, only flag security issues or major improvements.

            After completing, provide a summary table:
            | Crate | Current | Latest | Action | Reason |
            Include ALL checked crates, even ones you skipped.
